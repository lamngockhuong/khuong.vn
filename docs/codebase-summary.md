# Codebase Summary: kh∆∞∆°ng.vn

## Directory Structure

```bash
khuong.vn/
‚îú‚îÄ‚îÄ src/                           # Source files (entry point: Vite root)
‚îÇ   ‚îú‚îÄ‚îÄ index.html                 # Identity landing page template
‚îÇ   ‚îú‚îÄ‚îÄ main.ts                    # Identity entry point & theme logic
‚îÇ   ‚îú‚îÄ‚îÄ config.ts                  # TypeScript config types & import
‚îÇ   ‚îú‚îÄ‚îÄ themes.ts                  # Theme renderers (5 factories)
‚îÇ   ‚îú‚îÄ‚îÄ icons.ts                   # SVG icon library (17 icons)
‚îÇ   ‚îú‚îÄ‚îÄ styles.css                 # Identity page styles & theme classes
‚îÇ   ‚îú‚îÄ‚îÄ shared/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ theme.css              # CSS variables & shared theme utilities
‚îÇ   ‚îî‚îÄ‚îÄ apps/                      # Mini-apps framework
‚îÇ       ‚îú‚îÄ‚îÄ index.html             # Apps listing page
‚îÇ       ‚îú‚îÄ‚îÄ main.ts                # Apps listing entry & grid renderer
‚îÇ       ‚îú‚îÄ‚îÄ styles.css             # Apps listing page styles
‚îÇ       ‚îú‚îÄ‚îÄ apps.json              # App registry configuration
‚îÇ       ‚îî‚îÄ‚îÄ lucky-wheel/           # Lucky Wheel mini-app
‚îÇ           ‚îú‚îÄ‚îÄ index.html         # Wheel app HTML
‚îÇ           ‚îú‚îÄ‚îÄ main.ts            # Event handlers & initialization
‚îÇ           ‚îú‚îÄ‚îÄ wheel.ts           # LuckyWheel class (Canvas implementation)
‚îÇ           ‚îî‚îÄ‚îÄ styles.css         # Wheel-specific styles
‚îÇ
‚îú‚îÄ‚îÄ functions/                     # Cloudflare Pages Functions
‚îÇ   ‚îú‚îÄ‚îÄ _middleware.ts             # Request routing middleware
‚îÇ   ‚îî‚îÄ‚îÄ redirects.ts               # Short link redirect mappings
‚îÇ
‚îú‚îÄ‚îÄ public/                        # Static assets (favicons, images, sitemap, robots.txt)
‚îú‚îÄ‚îÄ scripts/                       # Build scripts
‚îÇ   ‚îî‚îÄ‚îÄ generate-sitemap.ts        # Auto-generate sitemap.xml from apps.json
‚îú‚îÄ‚îÄ dist/                          # Build output (generated by Vite)
‚îÇ
‚îú‚îÄ‚îÄ config.json                    # Site configuration (name, role, links, SEO)
‚îú‚îÄ‚îÄ biome.json                     # Biome linter & formatter configuration
‚îú‚îÄ‚îÄ wrangler.toml                  # Cloudflare Pages configuration
‚îú‚îÄ‚îÄ vite.config.ts                 # Vite build configuration
‚îú‚îÄ‚îÄ tsconfig.json                  # TypeScript configuration
‚îú‚îÄ‚îÄ package.json                   # Project metadata & scripts
‚îî‚îÄ‚îÄ README.md                      # User-facing documentation
```

## Source Files Overview

### Root Identity Layer

#### `src/index.html`

- **Purpose**: Main landing page template
- **Placeholders**: `%VITE_TITLE%`, `%VITE_DESCRIPTION%`, `%VITE_NAME%`, `%VITE_CANONICAL%`, `%VITE_OG_IMAGE%`, `%VITE_ANALYTICS%`
- **Script Entry**: Loads compiled `main.ts`

#### `src/main.ts`

- **Purpose**: Identity page logic and theme management
- **Key Functions**:
  - `renderThemes()`: Appends HTML for enabled themes to container
  - `setTheme(theme)`: Updates body class, indicator text, localStorage
  - `getRandomTheme(exclude)`: Returns random theme excluding specific one
  - `init()`: Initializes page on DOM ready
- **Lifecycle**:
  1. Import styles & config
  2. Render all theme HTML
  3. Select random initial theme (avoid last)
  4. Attach click listeners
  5. Inject custom CSS if configured

#### `src/config.ts`

- **Purpose**: TypeScript types and config import
- **Exports**:
  - Interface: `Link` - social link definition
  - Interface: `Avatar` - avatar configuration
  - Interface: `SEO` - SEO metadata
  - Interface: `Analytics` - analytics providers
  - Interface: `ThemeOverride` - per-theme color overrides
  - Interface: `Themes` - enabled themes list
  - Interface: `Config` - complete config structure
  - Const: `config` - imported from `config.json` at build time

#### `src/themes.ts`

- **Purpose**: Theme HTML generators
- **Exports**:
  - `themeNames`: Map of theme ID ‚Üí display name
  - `themes`: Map of theme ID ‚Üí HTML factory function
- **Theme Generators** (9 themes):
  - `terminal()`: CLI-style with prompt > and lowercase text
  - `brutalist()`: Minimal with dividers and separators
  - `gradient()`: Modern gradient with icon links
  - `glass()`: Glassmorphism card with avatar
  - `neobrutalism()`: Bold border card style
  - `retro()`: 8-bit pixel art with CRT scanlines
  - `minimal()`: Clean zen style with fade animation
  - `cyberpunk()`: Neon glow with gradient border
  - `paper()`: Hand-drawn notebook style
- **Pattern**: All use `renderTextLink()` or `renderIconLink()` helpers

#### `src/icons.ts`

- **Purpose**: SVG icon library
- **Icons**: globe, github, linkedin, facebook, x, twitter, youtube, instagram, telegram, discord, tiktok, devto, hashnode, medium, stackoverflow, email, apps
- **Format**: Inline SVG strings (viewBox="0 0 24 24")
- **Usage**: Referenced by theme renderers and icon links in config

#### `src/styles.css`

- **Purpose**: Identity page global styles and theme-specific styling
- **Sections**:
  - Root CSS variables (colors, fonts, spacing)
  - `.container`: Layout wrapper
  - `.theme-{name}-content`: Theme-specific classes
  - `.terminal-*`: Terminal theme styles
  - `.brutalist-*`: Brutalist theme styles
  - `.gradient-*`: Gradient theme styles
  - `.glass-*`: Glassmorphism styles
  - `.neobrutalism-*`: Neobrutalism styles
  - `.retro-*`: Retro/pixel art styles with CRT scanlines
  - `.minimal-*`: Minimal/zen styles with fade animation
  - `.cyberpunk-*`: Cyberpunk styles with neon glow
  - `.paper-*`: Paper/sketch styles with dashed border
  - `.theme-indicator`: Clickable theme switcher

#### `src/shared/theme.css`

- **Purpose**: Shared CSS variables and utilities
- **Contains**: Color palettes, typography, breakpoints for reuse across pages

### Apps Framework Layer

#### `src/apps/index.html`

- **Purpose**: Apps listing page template
- **Structure**: Apps grid container
- **Script Entry**: Loads compiled `apps/main.ts`

#### `src/apps/main.ts`

- **Purpose**: Apps listing page initialization
- **Key Function**: `renderApps()` - reads `apps.json`, renders cards in grid
- **Card Structure**: id, name, description, icon, path link
- **Lifecycle**: Load apps.json, loop entries, generate card HTML

#### `src/apps/apps.json`

- **Purpose**: App registry configuration
- **Schema**:

  ```json
  {
    "apps": [
      {
        "id": "lucky-wheel",
        "name": "V√≤ng quay may m·∫Øn",
        "description": "Quay s·ªë ng·∫´u nhi√™n...",
        "icon": "üé°",
        "path": "/apps/lucky-wheel/"
      }
    ]
  }
  ```

- **Extensibility**: Add new objects to enable new apps

#### `src/apps/styles.css`

- **Purpose**: Apps listing page styles
- **Components**: Grid layout, card styles, hover effects

### Lucky Wheel Mini-App Layer

#### `src/apps/lucky-wheel/index.html`

- **Purpose**: Wheel app page template
- **Elements**: Canvas element, spin button, result display
- **Script Entry**: Loads compiled `lucky-wheel/main.ts`

#### `src/apps/lucky-wheel/main.ts`

- **Purpose**: Event handlers and initialization
- **Key Features**:
  - Initialize LuckyWheel class with canvas
  - Set default segments from localStorage
  - Attach click handler to spin button
  - Display result in modal/toast
  - Handle canvas resize on window resize
- **Storage**: Persist custom segments to localStorage

#### `src/apps/lucky-wheel/wheel.ts`

- **Purpose**: LuckyWheel class - Canvas-based pie wheel
- **Class**: `LuckyWheel`
  - **Constructor**: Initialize canvas, setup, set default segments
  - **Methods**:
    - `setupCanvas()`: Size canvas accounting for DPR
    - `setDefaultSegments()`: 6 default segments (Vietnamese labels)
    - `setSegments(labels)`: Replace segments with custom labels
    - `setOnResult(callback)`: Register result callback
    - `spin()`: Animate wheel with ease-out-cubic, 4-second duration, 5+ revolutions
    - `announceResult()`: Calculate which segment won based on rotation
    - `isCurrentlySpinning()`: Check if animation in progress
    - `resize()`: Recalculate canvas size
  - **Private Methods**:
    - `draw()`: Render segments, borders, labels, center circle
    - `getContrastColor()`: Determine text color (black/white) based on segment
- **Animation**: requestAnimationFrame loop with ease-out-cubic timing
- **Accessibility**: Segment labels configurable, contrast-aware text

#### `src/apps/lucky-wheel/styles.css`

- **Purpose**: Wheel app specific styles
- **Components**: Canvas container, button styles, result display

### Configuration & Build Files

#### `config.json`

- **Purpose**: Site metadata consumed at build time
- **Sections**:
  - `name`: Display name (Kh∆∞∆°ng)
  - `role`: Job title/description
  - `avatar`: Avatar config (type: letter or image, value)
  - `links`: Array of social links with icons
  - `seo`: Title, description, canonical URL, OG image
  - `analytics`: Analytics provider config (goatcounter)
  - `themes`: Enabled themes list
  - `customCSS`: Optional inline CSS

#### `vite.config.ts`

- **Purpose**: Vite build configuration
- **Features**:
  - Multi-page build (main, apps, luckyWheel entries)
  - HTML transform plugin for SEO placeholders (main index only)
  - GoatCounter analytics script injection
  - Build output to `dist/`
  - Asset naming with hash for long-term caching
  - No single-file bundling (preserves multi-page structure)
- **Build Targets**: 3 entry points ‚Üí 3 HTML files + shared assets
- **Plugins**: Custom `html-transform` for config injection into main page

#### `wrangler.toml`

- **Purpose**: Cloudflare Pages configuration
- **Settings**:
  - Project name: khuongvn
  - Compatibility date: 2024-01-01
  - Pages build output directory: dist

#### `tsconfig.json`

- **Purpose**: TypeScript compiler options
- **Target**: ES2020, module resolution, strict mode

#### `package.json`

- **Purpose**: Node.js project metadata
- **Key Scripts**:
  - `dev`: Vite dev server (hot reload)
  - `dev:pages`: Cloudflare Pages local dev
  - `build`: TypeScript check + Vite build
  - `deploy`: Build + deploy to Cloudflare Pages
- **Dependencies**: TypeScript, Vite, Wrangler, Cloudflare Types

### Functions / Serverless

#### `functions/_middleware.ts`

- **Purpose**: Request routing middleware for Cloudflare Pages
- **Handler**: `onRequest` function
- **Logic**:
  1. Extract hostname and check for subdomain (e.g., `github.kh∆∞∆°ng.vn`)
  2. If subdomain matches redirect key: Return 301 redirect
  3. Fall back to path-based redirect (e.g., `kh∆∞∆°ng.vn/github`)
  4. If no match: Pass to next handler (static files)
- **Subdomain Support**: Handles both IDN (`kh∆∞∆°ng.vn`) and punycode (`xn--khng-5qa.vn`)
- **Export**: `PagesFunction` type from Cloudflare Workers

#### `functions/redirects.ts`

- **Purpose**: Short link mapping repository (used for both path and subdomain redirects)
- **Format**: `Record<string, string>` object
- **Entries**: 12 redirect keys with aliases (github/gh, linkedin/li, facebook/fb, etc.)
- **Usage**: Referenced by `_middleware.ts` for both `kh∆∞∆°ng.vn/{key}` and `{key}.kh∆∞∆°ng.vn`
- **Customization**: Edit this file to add/remove redirects

## Key Dependencies

### Development

- `typescript`: TypeScript compiler (5.9.3) - pinned version
- `vite`: Build tool and dev server (7.3.0) - pinned version
- `wrangler`: Cloudflare CLI for Pages/Workers (4.54.0) - pinned version
- `@cloudflare/workers-types`: Type definitions for Cloudflare Workers (4.20260101.0) - pinned version

**Note**: All versions are pinned without ^ or ~ prefixes for deterministic builds.

## Module Relationships

```bash
index.html
  ‚Üì
main.ts ‚Üê config.ts, themes.ts, icons.ts, styles.css
  ‚Üì
themes.ts (renders 9 theme variants)
  ‚Üì
styles.css (theme-specific CSS)

apps/index.html
  ‚Üì
apps/main.ts ‚Üê apps.json
  ‚Üì
apps/styles.css

apps/lucky-wheel/index.html
  ‚Üì
apps/lucky-wheel/main.ts ‚Üê wheel.ts
  ‚Üì
wheel.ts (Canvas rendering & animation)
  ‚Üì
apps/lucky-wheel/styles.css

functions/_middleware.ts ‚Üê redirects.ts
  ‚Üì
HTTP redirects

config.json (build-time consumption)
  ‚Üì
vite.config.ts (plugin injects values)
  ‚Üì
index.html (SEO placeholders replaced)
```

## Build Output Structure

```bash
dist/
‚îú‚îÄ‚îÄ index.html                     # Identity page
‚îú‚îÄ‚îÄ apps/index.html               # Apps listing
‚îú‚îÄ‚îÄ apps/lucky-wheel/index.html   # Wheel app
‚îî‚îÄ‚îÄ assets/
    ‚îú‚îÄ‚îÄ main-{hash}.js            # Identity logic
    ‚îú‚îÄ‚îÄ apps-{hash}.js            # Apps listing logic
    ‚îú‚îÄ‚îÄ luckyWheel-{hash}.js       # Wheel logic
    ‚îú‚îÄ‚îÄ main-{hash}.css           # Identity styles
    ‚îú‚îÄ‚îÄ apps-{hash}.css           # Apps listing styles
    ‚îú‚îÄ‚îÄ luckyWheel-{hash}.css      # Wheel styles
    ‚îú‚îÄ‚îÄ theme-{hash}.css           # Shared theme styles
    ‚îî‚îÄ‚îÄ modulepreload-polyfill-{hash}.js
```

## Extension Points

1. **Add New Theme**: Edit `src/themes.ts` ‚Üí add renderer function, register in `config.themes.enabled`
2. **Add Short Link**: Edit `functions/redirects.ts` ‚Üí add entry
3. **Add Mini-App**: Create `src/apps/{app-name}/` ‚Üí register in `src/apps/apps.json` ‚Üí add entry in `vite.config.ts` rollupOptions
4. **Customize Site Content**: Edit `config.json` ‚Üí rebuild (name, role, links, SEO, analytics)
5. **Add Config-Driven Link**: Add entry to `links` array in `config.json` (icon must exist in `src/icons.ts`)
